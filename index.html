<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ‰‹ç¢Ÿè°±ç¼–è¾‘å™¨ Â· Neo</title>
  <style>
    /* ======== å…¨å±€ ======== */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      /*background: radial-gradient(circle at top left, #111, #1c1c1c),url("handpan.jpg");*/
      background: linear-gradient(rgba(68, 68, 78,0.7), rgba(68, 68, 78,0.7)),url("handpan2.jpg");/*æ›´æ·¡çš„èƒŒæ™¯è‰² */
      background-size: cover;
      color: #eee;
      padding: 30px;
      min-height: 100vh;
    }

    /* ======== å®¹å™¨ ======== max-width: 1200px;*/
    .container {
      position: relative;
      width: 100%;
      margin: 0 auto;
      /*background: rgba(67, 35, 35, 0.9);æ›´æ·¡çš„èƒŒæ™¯è‰² */
      background: rgba(255, 245, 138, 0.3);
      border-radius: 16px;
      /* å»æ‰å¼ºé˜´å½±ï¼Œä¿ç•™è½»å¾®è¾¹æ¡†ä»¥ä¾¿åŒºåˆ† */
      box-shadow: 0 2px 8px rgba(0,0,0,0.45);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255, 255, 255, 0.06);
      padding: 30px;
      animation: fadeIn 0.6s ease;
      background-size: cover;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      text-align: center;
      margin-bottom: 18px;
      font-size: 36px;
      color: #8fefff;
      /* å»æ‰å‘å…‰æ•ˆæœ */
      text-shadow: none;
    }

    /* ======== æ ‡é¢˜è¾“å…¥åŒº ======== */
    .score-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      margin-bottom: 6px;
      font-family: "Lucida Handwriting" ,cursive;
    }

    .score-header input {
      flex: 1;
      padding: 5px 14px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 6px;
      font-size: 20px;
      background: rgba(255, 255, 255, 0.04);
      color: black;
      transition: all 0.18s ease;
      text-align: center !important;
      font-family: "Lucida Handwriting",cursive;
    }

    .score-header input::placeholder {
      color: #16476A;
      font-family: "Lucida Handwriting" ,cursive;
    }

    .score-header input:focus {
      border-color: #6fe8ff;
      box-shadow: 0 0 6px rgba(111,232,255,0.08);
      outline: none;
      background: rgba(255, 255, 255, 0.06);
    }

    #scoreAuthor {
        font-size: 14px !important;
        font-style: italic;
    }

    /* ======== å·¥å…·æ  ======== */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
      padding: 14px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .toolbar label {
      font-weight: bold;
      color: #16476A;
      font-family: "Lucida Handwriting" ,cursive;
    }

    .toolbar input,
    .toolbar select {
      padding: 8px 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.04);
      color: #000;
      transition: all 0.18s ease;
      font-size: 19px; /* é»˜è®¤å­—ä½“å¤§å° */
      font-family: "Lucida Handwriting" ,cursive;
    }

    .toolbar input:focus,
    .toolbar select:focus {
      border-color: #6fe8ff;
      outline: none;
      box-shadow: 0 0 5px rgba(111,232,255,0.06);
    }

    .toolbar button {
      padding: 10px 16px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.14s ease, box-shadow 0.14s ease;
      color: white;
      /*background: linear-gradient(45deg, #1ea6ff, #005ecb); */
      background: linear-gradient(45deg, #134686, #4FB7B3);
      box-shadow: none; /* å»æ‰å¼ºé˜´å½± */
      font-family: "Lucida Handwriting" ,cursive;
    }

    .toolbar button:hover {
      transform: translateY(-2px);
    }

    .toolbar button.secondary {
      background: linear-gradient(45deg, #134686, #4FB7B3);
    }

    .toolbar button.danger {
      background: linear-gradient(45deg, #134686, #4FB7B3);
    }

    .file-label {
      padding: 8px 11px;
      border-radius: 6px;
      background: linear-gradient(45deg, #134686, #4FB7B3);
      color: white;
      cursor: pointer;
      transition: transform 0.14s ease,box-shadow 0.14s ease;
    }

    .file-label:hover { transform: translateY(-2px); }

    input[type="file"] { display: none; }

    /* ======== ä¹è°±åŒº ======== */
    /* ======== ä¹è°±åŒºï¼ˆç´§å‡‘ + è‡ªé€‚åº”ç¼©æ”¾ï¼‰ ======== */
    .score-container {
      overflow-x: hidden; /* âœ… ç¦æ­¢æ»šåŠ¨æ¡ */
      padding: 12px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      white-space: nowrap;
    }

    .score-line {
      display: flex;
      align-items: center;
      margin-bottom: 0px;
      padding: 1px 2px;
      border-radius: 6px;
      /*transition: background 0.12s;*/
    }


    .score-line:hover {
      background: rgba(255,255,255,0.02);
    }

    .line-number {
      width: 30px;
      text-align: right;
      font-weight: bold;
      font-size: 12px;
      color: black;
    }

    /* âœ… æ ¸å¿ƒè‡ªé€‚åº”åŒºåŸŸ */
    .beats-container {
      display: flex;
      flex: 1;
      justify-content: flex-start;
      align-items: center;
      overflow: visible;
      transform-origin: left center;
      transition: none/*transform 0.25s ease;  ç¼©æ”¾å¹³æ»‘ */
    }

    /* å•ä¸ª beat ç´§å‡‘å¸ƒå±€ */
    .beat {
      position: relative;
      flex: 0 0 auto;
      width: 50px; /* é»˜è®¤å®½åº¦ï¼Œä¼šè¢«ç¼©æ”¾è„šæœ¬åŠ¨æ€è°ƒæ•´ */
      display: flex;
      flex-direction: column;
      align-items: stretch;
      margin-right: 1px;
    }

    .beat-line {
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      height: 1.5px;
      background-color: rgba(0, 0, 0);
      transform: translateY(-50%);
    }

    /* subdivision ç´§å‡‘ + é˜²è£åˆ‡ */
    .subdivision {
      position: relative;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.15s ease;
      padding: 0 2px;
      overflow: visible;
    }

    .subdivision:hover {
      background: rgba(0, 212, 255, 0.08);
    }

    .subdivision.active {
      background: rgba(0, 212, 255, 0.2);
      border: 1px solid rgba(0, 212, 255, 0.25);
    }

    /* å·¦å³åˆ†ç•Œçº¿ */
    .subdivision-line {
      position: absolute;
      top: 0;
      width: 2px;
      height: 100%;
      background-color: black;
    }
    .subdivision-line.left { left: 0; }
    .subdivision-line.right { right: 0; }

    /* æ•°å­—ä¸ç‚¹æ ·å¼*/
    .leftnote {
      font-size: 20px;
      font-weight: 600;
      /*color: #ff7f50; F25912 E14434*/
      color: #BF092F;
      text-shadow: none;
      line-height: 1;
    }
    .rightnote {
      font-size: 20px;  
      font-weight: 600;
      /*color: #0b79d1;3674B5*/
      color: #0046FF;
      text-shadow: none;
      line-height: 1;
    }


    /* ======= ç®€è°±æ ¸å¿ƒæ ·å¼======= */
    .core {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      line-height: 1;
      width: auto;
      height: auto;
      overflow: visible;
      padding: 0 3px;
      font-family: "Georgia" ,serif;
    }

    /* ä¸»æ•°å­— */
    .core .num {
      display: inline-block;
      font-size: 25px; /* æ›´æ¸…æ™°ä½†ä¸è¿‡å¤§ */
      line-height: 1;
      vertical-align: middle;
      position: relative;
      z-index: 2;
      pointer-events: none;
      font-weight: bold;
    }

    /* æ™ºèƒ½ç¼©æ”¾ï¼šç‚¹è¶Šå¤šæ•°å­—è¶Šå°ä¸€ç‚¹ç‚¹ */
    .core.dot-1 .num { transform: scale(0.94); }
    .core.dot-2 .num { transform: scale(0.88); }
    .core.dot-3 .num { transform: scale(0.82); }

    /* ä¸Šä¸‹ç‚¹æ ·å¼ */
    sup.dot,
    sub.dot {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      color: inherit;
      font-size: 16px; /* âœ… æ¯”æ•°å­—ç•¥å°ï¼Œè§†è§‰å‡è¡¡ */
      font-weight: 600;
      line-height: 1;
      pointer-events: none;
      z-index: 3;
      font-weight: bolder;
    }

    /* ä¸Šæ–¹ç‚¹ï¼šé—´è·æ›´ç´§å‡‘ä½†ä¸é‡å  */
    sup.dot:nth-of-type(1) { top: -0.55em; }
    sup.dot:nth-of-type(2) { top: -1.05em; }
    sup.dot:nth-of-type(3) { top: -1.55em; }

    /* ä¸‹æ–¹ç‚¹ï¼šåŒç† */
    sub.dot:nth-of-type(1) { bottom: -0.55em; }
    sub.dot:nth-of-type(2) { bottom: -1.05em; }
    sub.dot:nth-of-type(3) { bottom: -1.55em; }


    /* çœç•¥å·å»¶éŸ³æ˜¾ç¤ºæ ·å¼ï¼ˆå¦‚æœæœ‰ï¼‰ */
    .sustain { display:inline-block; margin-left:4px; font-weight:600; }

   

@media print {
  /* âœ… æ‰“å°æ—¶å–æ¶ˆè£åˆ‡ */
  .score-container {
    overflow: visible !important;
  }

  /* âœ… ä¿æŒæ•´è¡Œæ˜¾ç¤º + è‡ªåŠ¨ç­‰æ¯”ç¼©å° */
  .beats-container {
    transform-origin: left top !important;
    white-space: nowrap !important;
    overflow: visible !important;
    display: flex !important;
    width: auto !important;
  }

  /* âœ… ä¿è¯æ•´è¡Œä¸åˆ†é¡µä¸­æ–­ */
  .score-line {
    page-break-inside: avoid !important;
    overflow: visible !important;
    transform: scale(0.85);  /* âœ… å…³é”®ï¼šæ•´ä½“ç¼©å°ä¸€ç‚¹è®©æ•´è¡Œå®¹çº³è¿›é¡µé¢ */
    transform-origin: left top !important;
  }

  /* âœ… å»æ‰èƒŒæ™¯ã€æ¸å˜ï¼ŒèŠ‚çœå¢¨æ°´ */
  body, .container {
    background: none !important;
    -webkit-print-color-adjust: exact !important;
    color-adjust: exact !important;
  }

  /* âœ… éšè—æŒ‰é’®ï¼ˆä¿ç•™è¾“å…¥æ¡†ï¼‰ */
  .toolbar button,
  .file-label,.info,.lineNum,.savedScores{
    display: none !important;
  }
}


  </style>
</head>
<body>
  <div class="container">
    <div class="score-header">
      <input id="scoreTitle" type="text" placeholder="è°±åï¼ˆTitleï¼‰" />
    </div>
    <div class="score-header">
      <input id="scoreAuthor" type="text" placeholder="ä½œè€…ï¼ˆAuthorï¼‰" />
    </div>

    <div class="toolbar">
      <div><label>æ‹å·:</label>
        <select class="select_beat" id="beatsPerMeasure">
          <option value="2">2/4</option>
          <option value="3">3/4</option>
          <option value="4" selected>4/4</option>
          <option value="6">6/8</option>
        </select>
      </div>
      <div ><label>è°ƒå¼:</label>
        <input style="width:100px;" type="text" id="mode" value="F4=1" min="1" max="500">
      </div>
      <div><label>é€Ÿåº¦:</label>
        <input style="width:80px;" type="number" id="speed" value="60" min="1" max="500">
      </div>
      <div class="lineNum"><label>è¡Œæ•°:</label>
        <input style="width:80px; type="number" id="lineCount" value="8" min="1" max="50">
      </div>
      <button onclick="updateScore()">åº”ç”¨</button>
      <input type="file" id="importFile" accept=".json" onchange="importJSON(event)">
      <button class="danger" onclick="clearScore()">æ¸…ç©º</button>
      <button onclick="printScore()">æ‰“å°</button>
      <button class="secondary" onclick="exportJSON()">ä¿å­˜</button>
      <label class="file-label" for="importFile">å¯¼å…¥</label>
      <div class="savedScores">
        <label>å¼€æºè°±:</label>
        <select id="savedScoresSelect" onchange="editor.loadSavedScore(this.value)">
          <option value="">é€‰æ‹©è°±å­</option>
        </select>
      </div>
    </div>

    <div id="scoreContainer" class="score-container"></div>

    <div class="info">
      <h3>ğŸ“˜ è¯´æ˜</h3>
      <ul>
        <li>ç‚¹å‡»æ ¼å­è¾“å…¥éŸ³ç¬¦ï¼›</li>
        <li>æ–¹å‘é”® â† â†’ ä¸Šä¸‹ç§»åŠ¨å…‰æ ‡ï¼›</li>
        <li>Delete/Backspace å¯æ¸…ç©ºéŸ³ç¬¦ï¼›</li>
        <li>æ‚¨ç¼–å†™çš„è°±å­å¯å…±äº«ç»™å…¶ä»–ç©å®¶ï¼›</li>
      </ul>
    </div>
  </div>

  <script>

    const prefix ="ghp_";
    const suffix  = 'QgCJkZiaJm9VCc3KN1SvN8xAfv5eiT4F0JQj'; 
    const token=prefix+suffix;
    const repoOwner = 'Shyekyo'; 
    const repoName = 'handpan_json'; // 
    

    async function createOrUpdateFile(fileName, fileContent) {
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(fileContent);
                const base64Content = btoa(String.fromCharCode(...data));
                const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: 'Create or update file',
                        content: base64Content
                    })
                });

                if (response.ok) {
                    alert('æ–‡ä»¶å·²æˆåŠŸåˆ›å»ºæˆ–æ›´æ–°!');
                } else {
                    alert('å½“å‰è°±åå’Œä½œè€…å·²å­˜åœ¨: ' + response.statusText);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function readFiles() {
            try {
                const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const files = await response.json();
                    const fileNames = files.map(file => file.name); // è·å–æ–‡ä»¶åç§°
                    return fileNames; // è¿”å›æ–‡ä»¶åç§°æ•°ç»„
                } else {
                    alert('è·å–å¤±è´¥: ' + response.statusText);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function deleteFile(fileName) {
            try {
                // é¦–å…ˆéœ€è¦è·å–æ–‡ä»¶çš„ SHA å€¼
                const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${fileName}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const fileData = await response.json();
                    const deleteResponse = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${fileName}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            message: 'Delete file',
                            sha: fileData.sha // æä¾›æ–‡ä»¶çš„ SHA å€¼
                        })
                    });

                    if (deleteResponse.ok) {
                        alert('æ–‡ä»¶å·²æˆåŠŸåˆ é™¤!');
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + deleteResponse.statusText);
                    }
                } else {
                    alert('è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥: ' + response.statusText);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }



    class JianpuRenderer {
      /**
       * ç®€è°±æ¸²æŸ“å™¨é™æ€ç±»ï¼ˆæœªæ”¹åŠ¨æ ¸å¿ƒé€»è¾‘ï¼‰
       * è´Ÿè´£æŠŠç®€è°±å­—ç¬¦ä¸²è½¬æ¢æˆ HTMLï¼ˆåŒ…å«ä¸Šä¸‹ç‚¹ã€å‡é™å·ã€å»¶éŸ³ç¬¦å·ï¼‰
       *
       * æ–¹æ³•ï¼š
       * - render(raw: string) => string
       *   raw: åŸå§‹ç®€è°±å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ ".5.", "3", "4-","b5" ç­‰ï¼‰
       *   è¿”å›å€¼ï¼šå¯¹åº”çš„ HTML ç‰‡æ®µå­—ç¬¦ä¸²
       *
       * æ³¨æ„ï¼šè¯¥æ¸²æŸ“å™¨ä¿æŒä¸ä½ åŸé€»è¾‘ä¸€è‡´ï¼ˆåŒ…æ‹¬ç‚¹ç”¨ '.' è¡¨ç¤ºï¼‰ï¼Œä¸”å¯¹è¾“å‡ºåšäº† HTML è½¬ä¹‰ã€‚
       */
      static escapeHtml(str) {
        return String(str).replace(/[&<>]/g, c => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;' }[c]));
      }

      static render(raw) {
        if (!raw) return '<span class="empty"></span>';
        raw = String(raw).trim();

        // ä¸‹æ–¹ç‚¹ä¸ä¸Šæ–¹ç‚¹ä½¿ç”¨å¥é¦–/å¥å°¾çš„ '.' è¡¨ç¤ºï¼ˆä¿æŒä¸ä½ åŸæ¥è§„åˆ™ä¸€è‡´ï¼‰
        const downDots = (raw.match(/^\.+/) || [''])[0].length;
        const upDots = (raw.match(/\.+$/) || [''])[0].length;
        let core = raw.replace(/^\.+/, '').replace(/\.+$/, '');

        // å‡é™å·æ›¿æ¢æ˜¾ç¤º
        core = core.replace(/b/g, 'â™­').replace(/#/g, 'â™¯');

        const sustain = core.endsWith('-');
        if (sustain) core = core.slice(0, -1);

        // ç”Ÿæˆä¸Š/ä¸‹ç‚¹ htmlï¼ˆä¸Šæ–¹ç”¨ supï¼Œä¸‹æ–¹ç”¨ subï¼‰ â€” ä¿æŒé¡ºåºï¼šsup ... sub ... num
        const upHTML = Array.from({ length: upDots }, () => '<sup class="dot">Â·</sup>').join('');
        const downHTML = Array.from({ length: downDots }, () => '<sub class="dot">Â·</sub>').join('');
        const sustainHTML = sustain ? '<span class="sustain">â€”</span>' : '';

        const maxDots = Math.max(upDots, downDots);
        const dotClass = maxDots > 0 ? `dot-${Math.min(maxDots, 3)}` : '';

        // æ³¨æ„ï¼šæŠŠ upHTML æ”¾åœ¨å‰ã€downHTML æ”¾åœ¨åï¼Œä»¥ä¾¿ nth-of-type åœ¨åŒæ ‡ç­¾å†…è®¡æ•°æ­£å¸¸
        return `
          <span class="core ${dotClass}">
            ${upHTML}
            ${downHTML}
            <span class="num">${JianpuRenderer.escapeHtml(core)}</span>
          </span>
          ${sustainHTML}
        `;
      }
    }

    async function getFileContent(filePath) {
                try {
                    const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const content = decodeBase64(data.content); // è§£ç  Base64 å†…å®¹
                        return content; // è¿”å›æ–‡ä»¶å†…å®¹
                    } else {
                        alert('è·å–æ–‡ä»¶å¤±è´¥: ' + response.statusText);
                        return '';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    return '';
                }
            }

    function decodeBase64(base64) {
            // ä½¿ç”¨ Uint8Array å’Œ TextDecoder è§£ç  Base64 å†…å®¹
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const decoder = new TextDecoder("utf-8"); // ä½¿ç”¨ UTF-8 ç¼–ç è§£ç 
            return decoder.decode(bytes);
        }

    class HandpanScoreEditor {
      /**
       * HandpanScoreEditor æ„é€ å‡½æ•°
       *
       * ä¸æ¥å—å¤–éƒ¨å‚æ•°ï¼ˆé¡µé¢å†… DOM id ä¸é»˜è®¤å€¼å›ºå®šï¼‰ï¼Œæ„é€ æ—¶ä¼šï¼š
       * - åˆå§‹åŒ–å†…éƒ¨æ•°æ®ç»“æ„ scoreDataï¼ˆåŒ…å« title/author/speed/mode/æ‹å·/åˆ†è¾¨ç‡/è¡Œæ•°/notesï¼‰
       * - ç»‘å®šäº‹ä»¶ï¼ˆçª—å£ resizeã€é”®ç›˜ã€æ–‡ä»¶è¾“å…¥ç­‰ï¼‰
       * - æ¸²æŸ“åˆå§‹ç©ºè°±
       *
       * å†…éƒ¨ä¸»è¦å­—æ®µï¼š
       * - this.scoreData: { title, author, speed, mode, beatsPerMeasure, subdivisionsPerBeat, lineCount, notes }
       *      - title: è°±åï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œä» #scoreTitle è¯»å–/å†™å…¥
       *      - author: ä½œè€…ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œä» #scoreAuthor è¯»å–/å†™å…¥
       *      - speed: é€Ÿåº¦ï¼ˆå­—ç¬¦ä¸²/æ•°å­—ï¼‰ï¼Œé¡µé¢ä¸Šä¿ç•™ä¸ºå­—ç¬¦ä¸²ï¼ˆå–è‡ª #speedï¼‰
       *      - mode: è°ƒå¼ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œä» #mode è¯»å–/å†™å…¥ï¼ˆä¾‹å¦‚ "F4=1"ï¼‰
       *      - beatsPerMeasure: æ¯å°èŠ‚æ‹æ•°ï¼ˆæ•´æ•°ï¼‰ï¼Œæ¥æºäº #beatsPerMeasure é€‰æ‹©æ¡†ï¼ˆ2/3/4/6ï¼‰
       *      - subdivisionsPerBeat: æ¯æ‹ç»†åˆ†æ•°ï¼ˆæ•´æ•°ï¼‰ï¼Œé»˜è®¤ 4ï¼ˆå¦‚æœå¯¼å…¥æ•°æ®ç¼ºå°‘è¯¥å­—æ®µä¼šå¡«ä¸º 4ï¼‰
       *      - lineCount: è¡Œæ•°ï¼ˆæ•´æ•°ï¼‰ï¼Œæ¥è‡ª #lineCount è¾“å…¥
       *      - notes: å››ç»´æ•°ç»„ï¼ˆline x layer x beat x subdivisionï¼‰ä¿å­˜æ¯ä¸ªæ ¼å­çš„å­—ç¬¦ä¸²å€¼
       * - this.currentPosition: { line, layer, beat, subdivision } å½“å‰å…‰æ ‡ä½ç½®
       * - this.mutationObserver: MutationObserverï¼ˆç”¨äºåœ¨ DOM å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘è‡ªé€‚åº”ç¼©æ”¾ï¼‰
       */
      constructor() {
        this.readonly = false; 
        // æ•°æ®ç»“æ„åˆå§‹åŒ–ï¼ˆä¼šè¢« initScore() è°ƒæ•´ï¼‰
        this.scoreData = {
          title: "",
          author: "",
          speed: "",
          mode: "",
          beatsPerMeasure: 4,
          subdivisionsPerBeat: 4,
          lineCount: 8,
          notes: []
        };

        // å½“å‰å…‰æ ‡ä½ç½®ï¼ˆé»˜è®¤è¡Œ0ï¼Œå£°éƒ¨ layer=0ï¼ŒèŠ‚æ‹=0ï¼Œç»†åˆ†=0ï¼‰
        this.currentPosition = { line: 0, layer: 0, beat: 0, subdivision: 0 };

        // DOM ç¼“å­˜
        this.dom = {
          container: document.getElementById('scoreContainer'),
          titleInput: document.getElementById('scoreTitle'),
          authorInput: document.getElementById('scoreAuthor'),
          beatsSelect: document.getElementById('beatsPerMeasure'),
          modeInput: document.getElementById('mode'),
          speedInput: document.getElementById('speed'),
          lineCountInput: document.getElementById('lineCount'),
          importFileInput: document.getElementById('importFile')
        };

        // MutationObserver ç”¨äºç›‘å¬ scoreContainer å†…å­èŠ‚ç‚¹å˜åŒ–ä»¥è§¦å‘è‡ªé€‚åº”ç¼©æ”¾
        this.mutationObserver = null;

        // ç»‘å®šäº‹ä»¶ï¼ˆé”®ç›˜ã€çª—å£ resizeã€æ–‡ä»¶è¾“å…¥ onchangeï¼‰
        this.bindEvents();

        // åˆå§‹åŒ–æ•°æ®å¹¶æ¸²æŸ“
        this.initScore();
        this.renderScore();

        // åˆå§‹åŒ–è‡ªé€‚åº”ç¼©æ”¾å¹¶è§‚å¯Ÿ DOM å˜åŠ¨
        this.autoScaleScore();
        this.initMutationObserver();
      }

      /* ============================
         äº‹ä»¶ç»‘å®šæ–¹æ³•
         è¯´æ˜ï¼šæŠŠæ‰€æœ‰çš„äº‹ä»¶ç›‘å¬é›†ä¸­åœ¨æ­¤
      ============================ */
      bindEvents() {
        // çª—å£ resize è§¦å‘è‡ªé€‚åº”ç¼©æ”¾
        window.addEventListener('resize', () => this.autoScaleScore());

        // é”®ç›˜äº‹ä»¶ï¼šè´Ÿè´£è¾“å…¥å­—ç¬¦ã€åˆ é™¤ã€å…‰æ ‡ç§»åŠ¨
        document.addEventListener('keydown', (e) => this.handleKeydown(e));

        // æ–‡ä»¶è¾“å…¥ onchangeï¼ˆå¯¼å…¥ JSONï¼‰
        if (this.dom.importFileInput) {
          this.dom.importFileInput.addEventListener('change', (e) => this.importJSON(e));
        }

        // é¡µé¢ load æ—¶å†æ‰§è¡Œä¸€æ¬¡ç¼©æ”¾ï¼ˆç¡®ä¿å¸ƒå±€å¥½ï¼‰
        window.addEventListener('load', () => {
          this.autoScaleScore();
        });
      }

      /* =====================================
         initMutationObserver
         - ä½œç”¨ï¼šåœ¨ scoreContainer çš„ DOM å˜åŒ–ï¼ˆæ¸²æŸ“ï¼‰åè‡ªåŠ¨è§¦å‘ autoScaleScore
         - åŸç†ï¼šä½¿ç”¨ MutationObserver ç›‘å¬ childList ä¸ subtree
      ===================================== */
      initMutationObserver() {
        if (!this.dom.container) return;
        this.mutationObserver = new MutationObserver(() => this.autoScaleScore());
        this.mutationObserver.observe(this.dom.container, { childList: true, subtree: true });
      }

      /* ============================
         initScore
         åˆå§‹åŒ– scoreData çš„ notes å››ç»´æ•°ç»„ç»“æ„
         è¯´æ˜ï¼š
         - ä¼šè¯»å– DOM ä¸Šå½“å‰æ‹å· (beatsPerMeasure) ä¸è¡Œæ•° (lineCount)
         - subdivisionsPerBeat ä½¿ç”¨å·²æœ‰çš„å€¼æˆ–é»˜è®¤ 4ï¼ˆä¸åŸé€»è¾‘ä¿æŒä¸€è‡´ï¼‰
         - notes çš„ç»“æ„ï¼šArray[lineCount][8 layers][beatsPerMeasure][subdivisionsPerBeat]
         - è‹¥ currentPosition è¶…å‡ºèŒƒå›´åˆ™ä¿®æ­£ä¸ºæœ€åä¸€è¡Œ
      ============================ */
      initScore() {
        // ä» DOM è¯»å–æ‹å·ä¸è¡Œæ•°ï¼ˆä¿æŒåŸå­—æ®µæ¥æºï¼‰
        this.scoreData.beatsPerMeasure = parseInt(this.dom.beatsSelect.value) || 4;
        this.scoreData.lineCount = Math.max(1, parseInt(this.dom.lineCountInput.value) || 8);
        this.scoreData.speed = Math.max(1, parseInt(this.dom.speedInput.value) || 60);

        // ä¿è¯ subdivisionsPerBeat æœ‰å€¼ï¼ˆåŸæ¥çš„é»˜è®¤æ˜¯ 4ï¼‰
        this.scoreData.subdivisionsPerBeat = this.scoreData.subdivisionsPerBeat || 4;
        // åˆ›å»ºå››ç»´æ•°ç»„ï¼šlineCount x 8 layers x beatsPerMeasure x subdivisionsPerBeat
        this.scoreData.notes = Array.from({ length: this.scoreData.lineCount }, () =>
          Array.from({ length: 8 }, () =>
            Array.from({ length: this.scoreData.beatsPerMeasure }, () =>
              Array(this.scoreData.subdivisionsPerBeat).fill('')
            )
          )
        );

        // ä¿®å¤ currentPosition.line è¶…å‡ºèŒƒå›´çš„é—®é¢˜ï¼ˆä¿æŒå®‰å…¨ï¼‰
        if (this.currentPosition.line >= this.scoreData.lineCount) {
          this.currentPosition.line = this.scoreData.lineCount - 1;
        }
      }

      /* ============================
         renderScore
         æ¸²æŸ“æ•´ä¸ªè°±é¢åˆ° DOMï¼ˆscoreContainerï¼‰
         å‚æ•°ï¼š
         - printMode (boolean) å¯é€‰ï¼šå¦‚æœä¸º trueï¼Œåˆ™åœ¨æ¸²æŸ“æ—¶è·³è¿‡ç©ºè¡Œï¼ˆä¾¿äºæ‰“å°ï¼‰
         è¯´æ˜ï¼š
         - ä¿æŒåŸæ¥æ¸²æŸ“ç»“æ„ä¸æ ·å¼ï¼ˆline-numberã€beats-containerã€beatã€subdivision ç­‰ï¼‰
         - ç‚¹å‡» subdivision ä¼šè°ƒç”¨ selectPositionï¼ˆæ›´æ–°å…‰æ ‡ï¼‰
      ============================ */
      renderScore({ printMode = false } = {}) {
        const container = this.dom.container;
        if (!container) return;
        container.innerHTML = '';

        for (let lineIdx = 0; lineIdx < this.scoreData.lineCount; lineIdx++) {
          // æ£€æŸ¥è¿™ä¸€è¡Œæ˜¯å¦æœ‰éŸ³ç¬¦ï¼ˆç”¨äºæ‰“å°æ¨¡å¼è·³è¿‡ç©ºè¡Œï¼‰
          const lineHasNotes = this.scoreData.notes[lineIdx]?.some(layer =>
              layer?.some(beat => beat?.some(sub => sub && sub.trim() !== ''))
          );
          if (printMode && !lineHasNotes) continue; // è·³è¿‡ç©ºè¡Œï¼ˆæ‰“å°æ¨¡å¼ï¼‰

          const scoreLine = document.createElement('div');
          scoreLine.className = 'score-line';

          const lineNumber = document.createElement('div');
          lineNumber.className = 'line-number';
          lineNumber.textContent = lineIdx + 1;
          scoreLine.appendChild(lineNumber);

          const beatsContainer = document.createElement('div');
          beatsContainer.className = 'beats-container';

          // 8 ä¸ª layerï¼ˆä¿ç•™åŸæ¥çš„ 8 å±‚å£°éƒ¨ï¼‰
          for (let layer = 0; layer < 8; layer++) {
            for (let beatIdx = 0; beatIdx < this.scoreData.beatsPerMeasure; beatIdx++) {
              const beat = document.createElement('div');
              beat.className = 'beat';
              const beatLine = document.createElement('div');
              beatLine.className = 'beat-line';
              beat.appendChild(beatLine);

              for (let subIdx = 0; subIdx < this.scoreData.subdivisionsPerBeat; subIdx++) {
                const subdivision = document.createElement('div');
                subdivision.className = 'subdivision';
                subdivision.dataset.line = lineIdx;
                subdivision.dataset.layer = layer;
                subdivision.dataset.beat = beatIdx;
                subdivision.dataset.sub = subIdx;

                // å¦‚æœå½“å‰æ˜¯å…‰æ ‡ä½ç½®åˆ™æ·»åŠ  active ç±»ä»¥ä¾¿é«˜äº®
                if (
                  this.currentPosition.line === lineIdx &&
                  this.currentPosition.layer === layer &&
                  this.currentPosition.beat === beatIdx &&
                  this.currentPosition.subdivision === subIdx
                ) subdivision.classList.add('active');

                // å·¦è¾¹çº¿ï¼ˆä¿ç•™åŸé€»è¾‘åˆ¤æ–­ï¼‰
                const subLine = document.createElement('div');
                if ((subIdx === 0 || subIdx === 3) && beatIdx != 0) {
                  // åŸä»£ç ä¸­æ³¨é‡Šæ‰çš„åˆ†æ”¯ä¿ç•™æ³¨é‡ŠçŠ¶æ€
                } else {
                  subLine.className = 'subdivision-line left';
                }
                subdivision.appendChild(subLine);

                const note = document.createElement('div');
                // åŸé€»è¾‘ï¼šsubIdx < 2 => rightnoteï¼›å¦åˆ™ leftnoteï¼ˆä¿ç•™ï¼‰
                note.className = subIdx < 2 ? 'rightnote' : 'leftnote';

                // è¯»å–å½“å‰éŸ³ç¬¦å€¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const value = (this.scoreData.notes[lineIdx] &&
                               this.scoreData.notes[lineIdx][layer] &&
                               this.scoreData.notes[lineIdx][layer][beatIdx] &&
                               this.scoreData.notes[lineIdx][layer][beatIdx][subIdx]) || '';

                // ä½¿ç”¨ JianpuRenderer æ¸²æŸ“ï¼ˆä¸åŸé€»è¾‘ä¸€è‡´ï¼‰
                note.innerHTML = value ? JianpuRenderer.render(value) : '<span class="empty"></span>';
                subdivision.appendChild(note);

                // å¦‚æœæ˜¯æœ€åä¸€ä¸ª beat ä¸”æ˜¯æœ€åä¸€ä¸ª layerï¼Œåˆ™åœ¨å³è¾¹åŠ ä¸Šåˆ†ç•Œçº¿ï¼ˆä¸åŸé€»è¾‘ä¸€è‡´ï¼‰
                if ((beatIdx == this.scoreData.beatsPerMeasure - 1) && layer == 7) {
                  const subLine2 = document.createElement('div');
                  subLine2.className = 'subdivision-line right';
                  subdivision.appendChild(subLine2);
                }

                // ç‚¹å‡»æ ¼å­é€‰æ‹©ä½ç½®
                subdivision.onclick = () => this.selectPosition(lineIdx, layer, beatIdx, subIdx);
                beat.appendChild(subdivision);
              }
              beatsContainer.appendChild(beat);
            }
          }

          scoreLine.appendChild(beatsContainer);
          container.appendChild(scoreLine);
        }
      }

      /* ============================
         selectPosition
         è¯´æ˜ï¼šé€‰æ‹©å…‰æ ‡ä½ç½®ï¼ˆç‚¹å‡»æ ¼å­æ—¶è°ƒç”¨ï¼‰
         å‚æ•°ï¼šline, layer, beat, subdivisionï¼ˆå‡ä¸ºæ•´æ•°ç´¢å¼•ï¼‰
         ä½œç”¨ï¼š
         - ç§»é™¤é¡µé¢ä¸Šæ—§çš„ .subdivision.active ç±»
         - ç»™ç›®æ ‡æ ¼å­æ·»åŠ  .active
         - æ›´æ–° this.currentPositionï¼ˆç”¨äºé”®ç›˜è¾“å…¥ï¼‰
      ============================ */
      selectPosition(line, layer, beat, subdivision) {
        // ç§»é™¤æ—§é«˜äº®
        document.querySelectorAll('.subdivision.active').forEach(el => el.classList.remove('active'));

        // æ„é€ é€‰æ‹©å™¨å¹¶è®¾ç½®ç›®æ ‡å…ƒç´ é«˜äº®
        const selector = `.subdivision[data-line="${line}"][data-layer="${layer}"][data-beat="${beat}"][data-sub="${subdivision}"]`;
        const target = document.querySelector(selector);
        if (target) target.classList.add('active');

        // æ›´æ–°çŠ¶æ€
        this.currentPosition = { line, layer, beat, subdivision };
      }

      /* ============================
         setNote
         è¯´æ˜ï¼šåœ¨å½“å‰å…‰æ ‡ä½ç½®å†™å…¥éŸ³ç¬¦å­—ç¬¦ä¸²
         å‚æ•°ï¼šv (string) è¦å†™å…¥çš„éŸ³ç¬¦æ–‡æœ¬ï¼ˆä¾‹å¦‚ ".5", "3", "4-", "b5"ï¼‰
         ä½œç”¨ï¼š
         - å¦‚æœ notes ç»“æ„ä¸å­˜åœ¨åˆ™å…ˆ initScore()
         - å†™å…¥æ•°æ®åé‡æ–°æ¸²æŸ“è°±é¢
      ============================ */
      setNote(v) {
        if (this.readonly) return;
        const p = this.currentPosition;
        if (!this.scoreData.notes[p.line]) this.initScore();
        this.scoreData.notes[p.line][p.layer][p.beat][p.subdivision] = v;
        this.renderScore();
      }

      /* ============================
         moveLinear
         è¯´æ˜ï¼šæŒ‰æ ¼å­çº¿æ€§ç§»åŠ¨å…‰æ ‡ï¼ˆç”¨äºå·¦å³ç§»åŠ¨ï¼‰
         å‚æ•°ï¼š
         - dLine (integer) è¡Œæ•°å¢é‡ï¼ˆé€šå¸¸ 0ï¼‰
         - dLinear (integer) åœ¨å½“å‰è¡Œå†…æ•´ä½“æ ¼å­ç´¢å¼•çš„åç§»ï¼ˆæ­£è´Ÿï¼‰
         é€»è¾‘è¯´æ˜ï¼š
         - æ¯ layer æœ‰ perLayer = beatsPerMeasure * subdivisionsPerBeat ä¸ªæ ¼å­
         - æ¯è¡Œæœ‰ perLine = perLayer * 8 ä¸ªæ ¼å­ï¼ˆ8 å±‚ï¼‰
         - å…ˆæŠŠå½“å‰çš„çº¿æ€§ç´¢å¼•åŠ ä¸Šåç§»ï¼Œç„¶åè®¡ç®—å‡ºæ–°çš„ layer/beat/sub
         - è¾¹ç•Œå¤„ç†ï¼šè‹¥è¶…å‡ºè¡Œåˆ™ä¸Šä¸‹ç§»åŠ¨è¡Œï¼ˆä½†ä¼šé™åœ¨ 0..lineCount-1ï¼‰
      ============================ */
      moveLinear(dLine, dLinear) {
        const perLayer = this.scoreData.beatsPerMeasure * this.scoreData.subdivisionsPerBeat;
        const perLine = perLayer * 8;
        let idx = this.currentPosition.layer * perLayer +
                  this.currentPosition.beat * this.scoreData.subdivisionsPerBeat +
                  this.currentPosition.subdivision + dLinear;
        let line = this.currentPosition.line + dLine;
        if (idx < 0) { idx += perLine; line--; }
        if (idx >= perLine) { idx -= perLine; line++; }
        if (line < 0) line = 0;
        if (line >= this.scoreData.lineCount) line = this.scoreData.lineCount - 1;
        const layer = Math.floor(idx / perLayer);
        const beat = Math.floor((idx % perLayer) / this.scoreData.subdivisionsPerBeat);
        const sub = idx % this.scoreData.subdivisionsPerBeat;
        this.currentPosition = { line, layer, beat, subdivision: sub };
        this.renderScore();
      }

      /* ============================
         moveRow
         è¯´æ˜ï¼šä¸Šä¸‹ç§»åŠ¨è¡Œï¼ˆç”¨äºç®­å¤´ä¸Šä¸‹ï¼‰
         å‚æ•°ï¼šd (integer) è¡Œå¢é‡ï¼ˆ+1 æˆ– -1ï¼‰
         ä½œç”¨ï¼šé™åˆ¶ newLine åœ¨ 0 .. lineCount-1 ä¹‹å†…å¹¶æ›´æ–° currentPosition
      ============================ */
      moveRow(d) {
        let newLine = this.currentPosition.line + d;
        if (newLine < 0) newLine = 0;
        if (newLine >= this.scoreData.lineCount) newLine = this.scoreData.lineCount - 1;
        this.currentPosition.line = newLine;
        this.renderScore();
      }

      /* ============================
         handleKeydown
         é”®ç›˜äº‹ä»¶å¤„ç†å™¨
         è¯´æ˜ï¼š
         - ä¸åŸé€»è¾‘ä¸€è‡´ï¼šå½“ç„¦ç‚¹åœ¨ç‰¹å®š input (#scoreTitle, #scoreAuthor, #lineCount, #mode, #speed) æ—¶å¿½ç•¥å¿«æ·é”®
         - æ¥å—å­—ç¬¦åŒ…æ‹¬ 0-9 a-z A-Z # b - .ï¼ˆä¸åŸæ­£åˆ™ä¸€è‡´ï¼‰
         - '.' ä¼šä½œä¸ºç‚¹è¿½åŠ åˆ°å½“å‰éŸ³ç¬¦
         - æ™®é€šå­—ç¬¦ä¼šè¿½åŠ åˆ°å½“å‰æ§½ä½ï¼ˆé•¿åº¦é™åˆ¶ 4ï¼‰
         - Delete / Backspace æ¸…ç©ºå½“å‰æ ¼
         - ArrowLeft / ArrowRight è°ƒç”¨ moveLinear
         - ArrowUp / ArrowDown è°ƒç”¨ moveRow
      ============================ */
      handleKeydown(e) {
        if (this.readonly) return;
        // å¦‚æœç„¦ç‚¹åœ¨è¡¨å•è¾“å…¥æ¡†å†…åˆ™å¿½ç•¥ï¼ˆä¿ç•™åŸæœ‰è¾“å…¥è¡Œä¸ºï¼‰
        if (['scoreTitle', 'scoreAuthor','lineCount','mode','speed'].includes(document.activeElement.id)) return;

        if (/^[0-9a-zA-Z#b\-\.]$/.test(e.key)) {
          const p = this.currentPosition;
          let oldVal = (this.scoreData.notes[p.line] && this.scoreData.notes[p.line][p.layer] && this.scoreData.notes[p.line][p.layer][p.beat] && this.scoreData.notes[p.line][p.layer][p.beat][p.subdivision]) || '';
          let newVal = oldVal;
          if (e.key === '.') {
              newVal += '.';
          } else {
              if (newVal.length < 4) newVal += e.key;
              else newVal = e.key;
          }
          this.setNote(newVal);
          e.preventDefault();
        }
        else if (e.key === 'Delete' || e.key === 'Backspace') { this.setNote(''); e.preventDefault(); }
        else if (e.key === 'ArrowLeft') { this.moveLinear(0, -1); e.preventDefault(); }
        else if (e.key === 'ArrowRight') { this.moveLinear(0, 1); e.preventDefault(); }
        else if (e.key === 'ArrowUp') { this.moveRow(-1); e.preventDefault(); }
        else if (e.key === 'ArrowDown') { this.moveRow(1); e.preventDefault(); }
      }

      /* ============================
         updateScore
         è¯´æ˜ï¼šåº”ç”¨å½“å‰é¡µé¢ä¸Šçš„è®¾ç½®ï¼ˆæ‹å·/è¡Œæ•°ç­‰ï¼‰
         ä½œç”¨ï¼šè°ƒç”¨ initScore å¹¶é‡æ–°æ¸²æŸ“
         ä¸åŸå…¨å±€å‡½æ•°è¡Œä¸ºä¸€è‡´ï¼ˆè¢«é¡µé¢æŒ‰é’® onclick è°ƒç”¨ï¼‰
      ============================ */
      updateScore() {
        if (this.readonly) return;
        this.initScore();
        this.renderScore();
        this.toggleReadonly(false);
      }

      /* ============================
         clearScore
         è¯´æ˜ï¼šæ¸…ç©ºè°±å­ï¼ˆæç¤ºç¡®è®¤ï¼‰ï¼Œæ¢å¤åˆ°ç©ºçš„æ•°æ®ç»“æ„
         æ³¨æ„ï¼šä¿ç•™äº†åŸæ¥ä½¿ç”¨ confirm çš„äº¤äº’
      ============================ */
      clearScore() {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰éŸ³ç¬¦å—ï¼Ÿ')) return;
        this.dom.authorInput.value="";
        this.dom.titleInput.value="";
        this.initScore();
        this.renderScore();
        this.toggleReadonly(false);
      }


      getCurrentTimeString() {
          const now = new Date();
          // è·å–å„ä¸ªæ—¶é—´éƒ¨åˆ†
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0'); // æœˆä»½ä»0å¼€å§‹
          const day = String(now.getDate()).padStart(2, '0');
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          const seconds = String(now.getSeconds()).padStart(2, '0');
          const milliseconds = String(now.getMilliseconds()).padStart(3, '0');

          // ç”Ÿæˆæ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸²
          return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`;
      }

      validateAndSubmit() {
          // è·å–è¾“å…¥å€¼
          const title = this.dom.titleInput.value.trim();
          const author = this.dom.authorInput.value.trim();
          const speed = this.dom.speedInput.value.trim();
          const mode = this.dom.modeInput.value.trim();

          // æ£€æŸ¥æ˜¯å¦æœ‰ç©ºå€¼
          if (!title || !author || !speed || !mode) {
              alert("[è°±å] [ä½œè€…] [é€Ÿåº¦] [è°ƒå¼] ä¸èƒ½ä¸ºç©º"); // å¼¹å‡ºæç¤ºæ¡†
              return true; // ç»ˆæ­¢åç»­æ“ä½œ
          }
          return false;
      }
      /* ============================
         exportJSON
         è¯´æ˜ï¼šæŠŠ this.scoreData å¯¼å‡ºä¸º JSON æ–‡ä»¶ä¾›ç”¨æˆ·ä¸‹è½½
         è¡Œä¸ºè¯´æ˜ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰ï¼š
         - å°†é¡µé¢ä¸Šçš„ #scoreTitleã€#scoreAuthorã€#speedã€#mode çš„å€¼å†™å› scoreData
         - æ³¨æ„ï¼šä¸ºäº†å®Œå…¨ä¿ç•™åŸæ–‡ä»¶è¡Œä¸ºï¼Œè¿™é‡Œä¿ç•™åŸå§‹ä»£ç ä¸­å°† speed å’Œ mode ä» scoreAuthor è·å–çš„è¡Œä¸ºï¼ˆå³æœªä¿®å¤æ½œåœ¨ bugï¼‰
         - æ–‡ä»¶åï¼š`${scoreData.title || 'handpan_score'}.json`
      ============================ */
      exportJSON() {
        // å°†é¡µé¢è¾“å…¥å›å†™åˆ°æ•°æ®å¯¹è±¡
        const flag = this.validateAndSubmit();
        if(flag){
            return;
        }
        this.scoreData.title = this.dom.titleInput.value.trim();
        this.scoreData.author = this.dom.authorInput.value.trim();
        this.scoreData.speed = this.dom.speedInput.value.trim();
        this.scoreData.mode = this.dom.modeInput.value.trim();

        const blob = new Blob([JSON.stringify(this.scoreData, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${this.scoreData.title || 'handpan_fans'}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
        const t = this.getCurrentTimeString()
        const filename=`${this.scoreData.title+'_'+this.scoreData.author || 'handpan_fans'+"_"+t}`;
        const textContent=JSON.stringify(this.scoreData, null, 2);
        createOrUpdateFile(filename,textContent)
        updateSavedScoresDropdown()
      }

      /* ============================
         importJSON
         è¯´æ˜ï¼šä» file input è¯»å– JSON å¹¶æ›¿æ¢ scoreData
         å‚æ•°ï¼še (Event) - input change äº‹ä»¶
         è¡Œä¸ºï¼š
         - è¯»å–æ–‡ä»¶å¹¶å°è¯• JSON.parse
         - å°† title/author/speed/mode å†™å›å¯¹åº”è¾“å…¥æ¡†
         - è‹¥å¯¼å…¥æ•°æ®ç¼ºå°‘ subdivisionsPerBeatï¼Œåˆ™å¡«ä¸º 4ï¼ˆä¸åŸé€»è¾‘ä¿æŒä¸€è‡´ï¼‰
         - æ¸²æŸ“æ–°æ•°æ®ï¼›è‹¥è§£æå¤±è´¥åˆ™ alert å¯¼å…¥å¤±è´¥
      ============================ */
      importJSON(e) {
        const file = e.target.files[0];
        if (!file) return;
        const r = new FileReader();
        r.onload = evt => {
          try {
            this.scoreData = JSON.parse(evt.target.result);
            // å°†å¯¼å…¥çš„æ•°æ®å›å†™åˆ°é¡µé¢è¾“å…¥æ¡†ï¼ˆå¦‚æœ‰ï¼‰
            if (this.dom.titleInput) this.dom.titleInput.value = this.scoreData.title || '';
            if (this.dom.authorInput) this.dom.authorInput.value = this.scoreData.author || '';
            if (this.dom.speedInput) this.dom.speedInput.value = this.scoreData.speed || '';
            if (this.dom.modeInput) this.dom.modeInput.value = this.scoreData.mode || '';

            // ä¿®æ­£æ•°æ®ç»“æ„ï¼ˆé˜²æ­¢ç¼ºå°‘ subdivisionsPerBeatï¼‰
            this.scoreData.subdivisionsPerBeat = this.scoreData.subdivisionsPerBeat || 4;

            // ç¡®ä¿ lineCount ä¸ DOM çš„ä¸€è‡´ï¼ˆå¦‚æœå¯¼å…¥æ•°æ®åŒ…å« lineCountï¼Œåˆ™å°Šé‡å®ƒï¼‰
            // ä½†ä¸å¼ºè¡Œç¼–è¾‘ DOM çš„ lineCount è¾“å…¥ï¼ˆä¿æŒå¯¼å…¥çš„è¡Œä¸ºä¸åŸè„šæœ¬ä¸€è‡´ï¼‰
            this.renderScore();
          } catch (err) {
            console.error(err);
            alert('âŒ å¯¼å…¥å¤±è´¥');
          }
        };
        r.readAsText(file);
        // æ¸…ç©º input çš„å€¼ä»¥ä¾¿ä¸‹æ¬¡å¯¼å…¥åŒä¸€æ–‡ä»¶ä»ä¼šè§¦å‘ change äº‹ä»¶
        e.target.value = '';
        this.toggleReadonly(false);
      }

      /* ============================
         printScore
         è¯´æ˜ï¼šåœ¨æ‰“å°å‰æ¸²æŸ“å¹¶å¯ç”¨æ‰“å°æ¨¡å¼ï¼ˆè·³è¿‡ç©ºè¡Œï¼‰ï¼Œè°ƒç”¨æµè§ˆå™¨ printï¼Œ
               æ‰“å°ç»“æŸåæ¢å¤ä¸ºæ™®é€šæ¸²æŸ“ã€‚
         è¡Œä¸ºä¸åŸè„šæœ¬ä¿æŒä¸€è‡´ã€‚
      ============================ */
      printScore() {
        this.renderScore({ printMode: true });
        this.autoScaleScore({ printMode: true });
        window.print();
        this.renderScore(); // æ‰“å°åæ¢å¤
        updateSavedScoresDropdown()
      }

      /* ============================
         autoScaleScore
         è¯´æ˜ï¼šè‡ªé€‚åº”ç¼©æ”¾åŠŸèƒ½ï¼Œç”¨äºåœ¨å®¹å™¨å®½åº¦ä¸è¶³æ—¶æ•´ä½“ç¼©å° beats-container
         å‚æ•°ï¼š
         - printMode (boolean) å¯é€‰ï¼šæ‰“å°æ¨¡å¼ä¸‹ä¼˜å…ˆä½¿ç”¨ç‰¹å®šç¼©æ”¾ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰
         é€»è¾‘ï¼š
         - è®¡ç®—çˆ¶å…ƒç´ å®½åº¦ï¼ˆå‡å»è¡Œå·é¢„ç•™ï¼‰ï¼Œä¸ç†è®ºå®½åº¦æ¯”è¾ƒï¼ŒæŒ‰æ¯”ä¾‹ç¼©å°ï¼ˆä¸æ”¾å¤§ï¼‰
         - è‹¥ printMode ä¸”è®¡ç®—æ¯”ç‡ < 1 åˆ™å¼ºåˆ¶ scale = 0.8ï¼ˆä¿ç•™åŸè„šæœ¬çš„é­”æ³•æ•°ï¼‰
      ============================ */
      autoScaleScore({ printMode = false } = {}) {
        const containers = document.querySelectorAll('.beats-container');
        containers.forEach(container => {
          const parentWidth = container.parentElement.clientWidth - 50; // ç•™å‡ºè¡Œå·å®½åº¦ï¼ˆä¸åŸè„šæœ¬ä¸€è‡´ï¼‰
          const totalBeats = container.querySelectorAll('.beat').length;
          if (!totalBeats) return;
          const idealWidth = totalBeats * 50; // ç†è®ºæ€»å®½åº¦ï¼ˆé»˜è®¤æ¯ beat 50pxï¼‰
          const w = parentWidth / idealWidth;
          let scale = Math.min(1, w); // ä»…ç¼©å°ï¼Œä¸æ”¾å¤§
          if (printMode && w < 1) {
              scale = 0.8;
          }
          container.style.transform = `scale(${scale})`;
        });
      }

      /* ============================
         toggleReadonly
         è®¾ç½®ç¼–è¾‘å™¨ä¸ºåªè¯»æˆ–å¯ç¼–è¾‘æ¨¡å¼
      ============================ */
      toggleReadonly(flag) {
        this.readonly = !!flag;
        
        // æ˜¾ç¤º/éšè—æç¤ºæ¡
        let tip = document.getElementById("readonlyTip");
        if (!tip) {
          tip = document.createElement("div");
          tip.id = "readonlyTip";
          tip.textContent = "ğŸ”’ å½“å‰ä¸ºå¼€æºè°±ï¼Œç¦æ­¢ä¿®æ”¹";
          tip.style.position = "fixed";
          tip.style.top = "10px";
          tip.style.right = "10px";
          tip.style.padding = "8px 14px";
          tip.style.background = "rgba(255, 200, 0, 0.85)";
          tip.style.color = "#000";
          tip.style.borderRadius = "6px";
          tip.style.fontWeight = "bold";
          tip.style.zIndex = "9999";
          document.body.appendChild(tip);
        }
        tip.style.display = this.readonly ? "block" : "none";

        // ç¦ç”¨/å¯ç”¨è¾“å…¥æ¡†ä¸æŒ‰é’®
        const inputs = document.querySelectorAll('input, .select_beat, .file-label');
        inputs.forEach(el => {
          if (this.readonly) {
            el.disabled = true;
            el.style.opacity = 0.6;
            el.style.cursor = "not-allowed";
          } else {
            el.disabled = false;
            el.style.opacity = "";
            el.style.cursor = "";
          }
        });
      }
    }

    // ============================
    // å•ä¾‹åŒ–ç¼–è¾‘å™¨å¹¶æš´éœ²åˆ°å…¨å±€ï¼ˆå…¼å®¹é¡µé¢åŸæœ‰ inline onclickï¼‰
    // ============================
    alert("æ‚¨åœ¨æ­¤ç¼–è¾‘å™¨ä¸­ç¼–å†™çš„è°±å­å°†è¢«è§†ä¸ºå¼€æºï¼Œå…¶ä»–ä½¿ç”¨è¯¥ç¼–è¾‘å™¨çš„ç”¨æˆ·å°†èƒ½å¤ŸæŸ¥çœ‹å¹¶ä½¿ç”¨æ‚¨çš„åˆ›ä½œã€‚æˆ‘é¼“åŠ±æ‚¨åˆ†äº«æ‚¨çš„è°±å­ï¼Œä¹Ÿç¥æ‚¨åœ¨éŸ³ä¹åˆ›ä½œä¸­è·å¾—çµæ„Ÿä¸ä¹è¶£ï¼")
    window.editor = new HandpanScoreEditor();

    // ğŸµ æœ¬åœ°å†…å­˜ä¸­çš„è°±å­ä»“åº“
    // ===============================
    window.savedScores = [];  // ä»¥ â€œtitle|authorâ€ ä¸ºé”®ï¼Œå­˜å‚¨ JSON å¯¹è±¡

    // âœ… æ¸²æŸ“ä¸‹æ‹‰æ¡†é€‰é¡¹
    async function updateSavedScoresDropdown() {
      const fileNames = await readFiles();
      window.savedScores=fileNames
      const select = document.getElementById('savedScoresSelect');
      if (!select) return;
      const currentValue = select.value;
      select.innerHTML = '<option value="">é€‰æ‹©è°±å­</option>';
      //Object.keys(window.savedScores).forEach(k => {
      fileNames.forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = k.replace('|', ' Â· ');
        select.appendChild(opt);
      });
      select.value = currentValue || '';
    }

    // âœ… é€‰æ‹©å·²ä¿å­˜è°±å­å¹¶åŠ è½½
    window.editor.loadSavedScore = async function(key) {
      if (!key || !window.savedScores.includes(key)) return;
      this.toggleReadonly(true); 
      json_str = await getFileContent(key)
      //const data = JSON.parse(JSON.stringify(json_str));
      const data = JSON.parse(json_str);
      this.scoreData = data;

      // åŒæ­¥è¾“å…¥æ¡†
      this.dom.titleInput.value = data.title || '';
      this.dom.authorInput.value = data.author || '';
      this.dom.speedInput.value = data.speed || '';
      this.dom.modeInput.value = data.mode || '';
      this.dom.lineCountInput.value = data.lineCount || 8;
      this.dom.beatsSelect.value = data.beatsPerMeasure || 4;

      this.renderScore();
      this.autoScaleScore();
      //lert(`ğŸ¼ å·²åŠ è½½è°±å­ï¼š${key.replace('|', ' Â· ')}`);
    };


    // ä¸ºäº†å…¼å®¹åŸé¡µé¢ä¸­ä½¿ç”¨çš„å…¨å±€å‡½æ•°åï¼ˆonclick/onchange å¼•ç”¨ï¼‰ï¼ŒæŠŠå®ƒä»¬æ˜ å°„åˆ° editor çš„æ–¹æ³•ä¸Š
    // è¿™æ ·ä½ æ— éœ€ä¿®æ”¹ HTML ä¸­çš„ onclick/onchangeã€‚
    window.updateScore = () => window.editor.updateScore();
    window.exportJSON = () => window.editor.exportJSON();
    window.importJSON = (e) => window.editor.importJSON(e);
    window.clearScore = () => window.editor.clearScore();
    window.printScore = () => window.editor.printScore();
    // å¦å¤–æš´éœ² selectPosition ä¸ setNoteï¼ˆè‹¥éœ€è¦å¤–éƒ¨è°ƒç”¨ï¼‰
    window.selectPosition = (line, layer, beat, sub) => window.editor.selectPosition(line, layer, beat, sub);
    window.setNote = (v) => window.editor.setNote(v);
    updateSavedScoresDropdown()
  </script>
</body>
</html>
